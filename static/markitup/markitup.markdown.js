// -------------------------------------------------------------------
// markItUp!
// -------------------------------------------------------------------
// Copyright (C) 2008 Jay Salvat
// http://markitup.jaysalvat.com/
// -------------------------------------------------------------------
function togglePreview(m) {
	$(($(m.textarea).attr('rel'))).toggle();
}
mySettings = {
	previewParserPath:	'',
	onShiftEnter:		{keepDefault:false, openWith:'\n\n'},
	markupSet: [
		//{name:'Second Level Heading', key:'2', placeHolder:'Your title here...', closeWith:function(markItUp) { return miu.markdownTitle(markItUp, '-');} },
		{name:'Heading 3', key:'3', openWith:'### ', placeHolder:'Your title here...' },
		{name:'Heading 4', key:'4', openWith:'#### ', placeHolder:'Your title here...' },
		{separator:'---------------' },		
		{name:'Bold', key:'B', openWith:'**', closeWith:'**'},
		{name:'Italic', key:'I', openWith:'_', closeWith:'_'},
		{separator:'---------------' },
		{name:'Bulleted List', openWith:'- ' },
		{name:'Numeric List', openWith:function(markItUp) {
			return markItUp.line+'. ';
		}},
		{separator:'---------------' },
		{name:'Picture', key:'P', replaceWith:'![[![Alternative text]!]]([![Url:!:http://]!] "[![Title]!]")'},
		{name:'Link', key:'L', openWith:'[', closeWith:']([![Url:!:http://]!] "[![Title]!]")', placeHolder:'Your text to link here...' },
		{separator:'---------------'},	
		{name:'Quotes', openWith:'> '},
		{name:'Code Block / Code', openWith:'(!(\t|!|`)!)', closeWith:'(!(`)!)'},
		{separator:'---------------'},	
		{name:'Insert Slideshow', key: 'S', className:'slideshow', openWith:'{{ slideshow }}\n'},
		{name:'Insert Youtube Video', key: 'Y', className:'youtube', openWith:'{{ youtube ', 
			closeWith: '[![Paste the url here, eg. http://youtube.com/watch?v=_VZ1QnKSpgc:!:]!] }}', placeHolder: ''},
		{name:'Insert Vimeo Video', key: 'V', className:'vimeo', openWith:'{{ vimeo ', 
			closeWith: '[![Paste the url here, eg. http://vimeo.com/1299394:!:]!] }}', placeHolder: ''},
		{name:'Insert Survey (from your Google Spreadsheet)', className:'gform', 
			closeWith: function(markItUp) { return miu.askGForm(markItUp);}, placeHolder: ''},
		{separator:'---------------'},
		{name:'Show/Hide Preview', openWith:function(m) { togglePreview(m); }, className:"tPreview"},
		{name:'Preview', call:'preview', className:"preview"}
	]
};

// mIu nameSpace to avoid conflict.
miu = {
	markdownTitle: function(markItUp, char) {
		heading = '';/* markdown */
		n = $.trim(markItUp.selection||markItUp.placeHolder).length;
		for(i = 0; i < n; i++) {
			heading += char;
		}
		return '\n'+heading;
	},
	askGForm: function(markItUp) {
		//'[![Paste the google form ID here, eg. c45420VZ1QnKSpgc:!:]!] }}'
		var code = prompt("Paste the code you get from Google, eg. <iframe src=...");
		if (code != null) {
			result = code.match(/\?key\=(\w+)\"/);
			if (result != null) {
				return "{{ survey " + result[1] + " }}";
			} else {
				alert("Please check your code. ")
			}
		}
	}
};

/*
Showdown
Copyright (c) 2007, John Fraser  
<http://www.attacklab.net/>  
All rights reserved.
*/
var Showdown={};
Showdown.converter=function(){var h,i,n,o=0;this.makeHtml=function(a){h=[];i=[];n=[];a=a.replace(/~/g,"~T");a=a.replace(/\$/g,"~D");a=a.replace(/\r\n/g,"\n");a=a.replace(/\r/g,"\n");a="\n\n"+a+"\n\n";a=u(a);a=a.replace(/^[ \t]+$/mg,"");a=v(a);a=B(a);a=p(a);a=w(a);a=a.replace(/~D/g,"$$");return a=a.replace(/~T/g,"~")};function B(a){return a=a.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|\Z)/gm,function(b,d,c,e,g){d=d.toLowerCase();h[d]=x(c);
if(e)return e+g;else if(g)i[d]=g.replace(/"/g,"&quot;");return""})}function v(a){a=a.replace(/\n/g,"\n\n");a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,l);a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,l);a=a.replace(/(\n[ ]{0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,l);a=a.replace(/(\n\n[ ]{0,3}<!(--[^\r]*?--\s*)+>[ \t]*(?=\n{2,}))/g,
l);a=a.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,l);return a=a.replace(/\n\n/g,"\n")}function l(a,b){a=b;a=a.replace(/\n\n/g,"\n");a=a.replace(/^\n/,"");a=a.replace(/\n+$/g,"");return a="\n\n~K"+(n.push(a)-1)+"K\n\n"}function p(a){a=C(a);var b=j("<hr />");a=a.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,b);a=a.replace(/^[ ]{0,2}([ ]?\-[ ]?){3,}[ \t]*$/gm,b);a=a.replace(/^[ ]{0,2}([ ]?\_[ ]?){3,}[ \t]*$/gm,b);a=y(a);a=D(a);a=E(a);a=v(a);return a=F(a)}function m(a){a=G(a);a=
H(a);a=I(a);a=J(a);a=K(a);a=L(a);a=x(a);a=M(a);return a=a.replace(/  +\n/g," <br />\n")}function H(a){var b=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi;return a=a.replace(b,function(d){d=d.replace(/(.)<\/?code>(?=.)/g,"$1`");return d=k(d,"\\`*_")})}function K(a){a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,q);a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?(.*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,q);return a=a.replace(/(\[([^\[\]]+)\])()()()()()/g,
q)}function q(a,b,d,c,e,g,N,f){if(f==undefined)f="";a=b;d=d;c=c.toLowerCase();e=e;f=f;if(e==""){if(c=="")c=d.toLowerCase().replace(/ ?\n/g," ");if(h[c]!=undefined){e=h[c];if(i[c]!=undefined)f=i[c]}else if(a.search(/\(\s*\)$/m)>-1)e="";else return a}e=k(e,"*_");e='<a href="'+e+'"';if(f!=""){f=f.replace(/"/g,"&quot;");f=k(f,"*_");e+=' title="'+f+'"'}e+=">"+d+"</a>";return e}function J(a){a=a.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,z);return a=a.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,
z)}function z(a,b,d,c,e,g,N,f){a=b;d=d;c=c.toLowerCase();e=e;(f=f)||(f="");if(e==""){if(c=="")c=d.toLowerCase().replace(/ ?\n/g," ");if(h[c]!=undefined){e=h[c];if(i[c]!=undefined)f=i[c]}else return a}d=d.replace(/"/g,"&quot;");e=k(e,"*_");e='<img src="'+e+'" alt="'+d+'"';f=f.replace(/"/g,"&quot;");f=k(f,"*_");e+=' title="'+f+'"';e+=" />";return e}function C(a){a=a.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(b,d){return j("<h1>"+m(d)+"</h1>")});a=a.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(b,
d){return j("<h2>"+m(d)+"</h2>")});return a=a.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(b,d,c){b=d.length;return j("<h"+b+">"+m(c)+"</h"+b+">")})}var r;function y(a){a+="~0";var b=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;if(o)a=a.replace(b,function(d,c,e){d=c;e=e.search(/[*+-]/g)>-1?"ul":"ol";d=d.replace(/\n{2,}/g,"\n\n\n");d=r(d);d=d.replace(/\s+$/,"");return d="<"+e+">"+d+"</"+e+">\n"});else{b=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g;
a=a.replace(b,function(d,c,e,g){d=c;e=e;g=g.search(/[*+-]/g)>-1?"ul":"ol";e=e.replace(/\n{2,}/g,"\n\n\n");e=r(e);return e=d+"<"+g+">\n"+e+"</"+g+">\n"})}return a=a.replace(/~0/,"")}r=function(a){o++;a=a.replace(/\n{2,}$/,"\n");a+="~0";a=a.replace(/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm,function(b,d,c,e,g){b=g;if((d=d)||b.search(/\n{2,}/)>-1)b=p(s(b));else{b=y(s(b));b=b.replace(/\n$/,"");b=m(b)}return"<li>"+b+"</li>\n"});a=a.replace(/~0/g,"");o--;
return a};function D(a){a+="~0";a=a.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(b,d,c){b=d;c=c;b=A(s(b));b=u(b);b=b.replace(/^\n+/g,"");b=b.replace(/\n+$/g,"");b="<pre><code>"+b+"\n</code></pre>";return j(b)+c});return a=a.replace(/~0/,"")}function j(a){a=a.replace(/(^\n+|\n+$)/g,"");return"\n\n~K"+(n.push(a)-1)+"K\n\n"}function G(a){return a=a.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(b,d,c,e){b=e;b=b.replace(/^([ \t]*)/g,"");b=b.replace(/[ \t]*$/g,
"");b=A(b);return d+"<code>"+b+"</code>"})}function A(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");return a=k(a,"*_{}[]\\",false)}function M(a){a=a.replace(/(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\1/g,"<strong>$2</strong>");return a=a.replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>")}function E(a){return a=a.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(b,d){b=d;b=b.replace(/^[ \t]*>[ \t]?/gm,"~0");b=b.replace(/~0/g,"");b=b.replace(/^[ \t]+$/gm,"");b=p(b);b=b.replace(/(^|\n)/g,
"$1  ");b=b.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(c,e){c=e;c=c.replace(/^  /mg,"~0");return c=c.replace(/~0/g,"")});return j("<blockquote>\n"+b+"\n</blockquote>")})}function F(a){a=a.replace(/^\n+/g,"");a=a.replace(/\n+$/g,"");var b=a.split(/\n{2,}/g);a=[];for(var d=b.length,c=0;c<d;c++){var e=b[c];if(e.search(/~K(\d+)K/g)>=0)a.push(e);else if(e.search(/\S/)>=0){e=m(e);e=e.replace(/^([ \t]*)/g,"<p>");e+="</p>";a.push(e)}}d=a.length;for(c=0;c<d;c++)for(;a[c].search(/~K(\d+)K/)>=0;){b=n[RegExp.$1];
b=b.replace(/\$/g,"$$$$");a[c]=a[c].replace(/~K\d+K/,b)}return a.join("\n\n")}function x(a){a=a.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;");return a=a.replace(/<(?![a-z\/?\$!])/gi,"&lt;")}function I(a){a=a.replace(/\\(\\)/g,t);return a=a.replace(/\\([`*_{}\[\]()>#+-.!])/g,t)}function L(a){a=a.replace(/<((https?|ftp|dict):[^'">\s]+)>/gi,'<a href="$1">$1</a>');return a=a.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,function(b,d){return O(w(d))})}function O(a){function b(c){var e=
"0123456789ABCDEF";c=c.charCodeAt(0);return e.charAt(c>>4)+e.charAt(c&15)}var d=[function(c){return"&#"+c.charCodeAt(0)+";"},function(c){return"&#x"+b(c)+";"},function(c){return c}];a="mailto:"+a;a=a.replace(/./g,function(c){if(c=="@")c=d[Math.floor(Math.random()*2)](c);else if(c!=":"){var e=Math.random();c=e>0.9?d[2](c):e>0.45?d[1](c):d[0](c)}return c});a='<a href="'+a+'">'+a+"</a>";return a=a.replace(/">.+:/g,'">')}function w(a){return a=a.replace(/~E(\d+)E/g,function(b,d){b=parseInt(d);return String.fromCharCode(b)})}
function s(a){a=a.replace(/^(\t|[ ]{1,4})/gm,"~0");return a=a.replace(/~0/g,"")}function u(a){a=a.replace(/\t(?=\t)/g,"    ");a=a.replace(/\t/g,"~A~B");a=a.replace(/~B(.+?)~A/g,function(b,d){b=d;d=4-b.length%4;for(var c=0;c<d;c++)b+=" ";return b});a=a.replace(/~A/g,"    ");return a=a.replace(/~B/g,"")}function k(a,b,d){b="(["+b.replace(/([\[\]\\])/g,"\\$1")+"])";if(d)b="\\\\"+b;d=new RegExp(b,"g");return a=a.replace(d,t)}function t(a,b){a=b.charCodeAt(0);return"~E"+a+"E"}};


//----------------------------------------------------------------------------
//markItUp! Universal MarkUp Engine, JQuery plugin
//v 1.1.5
//Dual licensed under the MIT and GPL licenses.
//----------------------------------------------------------------------------
//Copyright (C) 2007-2008 Jay Salvat
//http://markitup.jaysalvat.com/
//---------------------------------
(function($){$.fn.markItUp=function(settings,extraSettings){var options,ctrlKey,shiftKey,altKey;ctrlKey=shiftKey=altKey=false;var converter=new Showdown.converter();options={id:"",nameSpace:"",root:"",previewInWindow:"",previewAutoRefresh:true,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParserPath:"",previewParserVar:"data",resizeHandle:true,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};$.extend(options,settings,extraSettings);if(!options.root){$("script").each(function(a,tag){miuScript=$(tag).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);if(miuScript!==null){options.root=miuScript[1]}})}return this.each(function(){var $$,textarea,levels,scrollPosition,caretPosition,caretOffset,clicked,hash,header,footer,previewWindow,template,iFrame,abort;$$=$(this);textarea=this;levels=[];abort=false;scrollPosition=caretPosition=0;caretOffset=-1;options.previewParserPath=localize(options.previewParserPath);options.previewTemplatePath=localize(options.previewTemplatePath);function localize(data,inText){if(inText){return data.replace(/("|')~\//g,"$1"+options.root)}return data.replace(/^~\//,options.root)}function init(){id="";nameSpace="";if(options.id){id='id="'+options.id+'"'}else{if($$.attr("id")){id='id="markItUp'+($$.attr("id").substr(0,1).toUpperCase())+($$.attr("id").substr(1))+'"'}}if(options.nameSpace){nameSpace='class="'+options.nameSpace+'"'}$$.wrap("<div "+nameSpace+"></div>");$$.wrap("<div "+id+' class="markItUp"></div>');$$.wrap('<div class="markItUpContainer"></div>');$$.addClass("markItUpEditor");header=$('<div class="markItUpHeader"></div>').insertBefore($$);$(dropMenus(options.markupSet)).appendTo(header);footer=$('<div class="markItUpFooter"></div>').insertAfter($$);if(options.resizeHandle===true&&$.browser.safari!==true){resizeHandle=$('<div class="markItUpResizeHandle"></div>').insertAfter($$).bind("mousedown",function(e){var h=$$.height(),y=e.clientY,mouseMove,mouseUp;mouseMove=function(e){$$.css("height",Math.max(20,e.clientY+h-y)+"px");return false};mouseUp=function(e){$("html").unbind("mousemove",mouseMove).unbind("mouseup",mouseUp);return false};$("html").bind("mousemove",mouseMove).bind("mouseup",mouseUp)});footer.append(resizeHandle)}$$.keydown(keyPressed).keyup(keyPressed);$$.bind("insertion",function(e,settings){if(settings.target!==false){get()}if(textarea===$.markItUp.focused){markup(settings)}});$$.focus(function(){$.markItUp.focused=this})}function dropMenus(markupSet){var ul=$("<ul></ul>"),i=0;$("li:hover > ul",ul).css("display","block");$.each(markupSet,function(){var button=this,t="",title,li,j;title=(button.key)?(button.name||"")+" [Ctrl+"+button.key+"]":(button.name||"");key=(button.key)?'accesskey="'+button.key+'"':"";if(button.separator){li=$('<li class="markItUpSeparator">'+(button.separator||"")+"</li>").appendTo(ul)}else{i++;for(j=levels.length-1;j>=0;j--){t+=levels[j]+"-"}li=$('<li class="markItUpButton markItUpButton'+t+(i)+" "+(button.className||"")+'"><a href="" '+key+' title="'+title+'">'+(button.name||"")+"</a></li>").bind("contextmenu",function(){return false}).click(function(){return false}).mouseup(function(){if(button.call){eval(button.call)()}markup(button);return false}).hover(function(){$("> ul",this).show();$(document).one("click",function(){$("ul ul",header).hide()})},function(){$("> ul",this).hide()}).appendTo(ul);if(button.dropMenu){levels.push(i);$(li).addClass("markItUpDropMenu").append(dropMenus(button.dropMenu))}}});levels.pop();return ul}function magicMarkups(string){if(string){string=string.toString();string=string.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(x,a){var b=a.split("|!|");if(altKey===true){return(b[1]!==undefined)?b[1]:b[0]}else{return(b[1]===undefined)?"":b[0]}});string=string.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(x,a){var b=a.split(":!:");if(abort===true){return false}value=prompt(b[0],(b[1])?b[1]:"");if(value===null){abort=true}return value});return string}return""}function prepare(action){if($.isFunction(action)){action=action(hash)}return magicMarkups(action)}function build(string){openWith=prepare(clicked.openWith);placeHolder=prepare(clicked.placeHolder);replaceWith=prepare(clicked.replaceWith);closeWith=prepare(clicked.closeWith);if(replaceWith!==""){block=openWith+replaceWith+closeWith}else{if(selection===""&&placeHolder!==""){block=openWith+placeHolder+closeWith}else{block=openWith+(string||selection)+closeWith}}return{block:block,openWith:openWith,replaceWith:replaceWith,placeHolder:placeHolder,closeWith:closeWith}}function markup(button){var len,j,n,i;hash=clicked=button;get();$.extend(hash,{line:"",root:options.root,textarea:textarea,selection:(selection||""),caretPosition:caretPosition,ctrlKey:ctrlKey,shiftKey:shiftKey,altKey:altKey});prepare(options.beforeInsert);prepare(clicked.beforeInsert);if(ctrlKey===true&&shiftKey===true){prepare(clicked.beforeMultiInsert)}$.extend(hash,{line:1});if(ctrlKey===true&&shiftKey===true){lines=selection.split(/\r?\n/);for(j=0,n=lines.length,i=0;i<n;i++){if($.trim(lines[i])!==""){$.extend(hash,{line:++j,selection:lines[i]});lines[i]=build(lines[i]).block}else{lines[i]=""}}string={block:lines.join("\n")};start=caretPosition;len=string.block.length+(($.browser.opera)?n:0)}else{if(ctrlKey===true){string=build(selection);start=caretPosition+string.openWith.length;len=string.block.length-string.openWith.length-string.closeWith.length;len-=fixIeBug(string.block)}else{if(shiftKey===true){string=build(selection);start=caretPosition;len=string.block.length;len-=fixIeBug(string.block)}else{string=build(selection);start=caretPosition+string.block.length;len=0;start-=fixIeBug(string.block)}}}if((selection===""&&string.replaceWith==="")){caretOffset+=fixOperaBug(string.block);start=caretPosition+string.openWith.length;len=string.block.length-string.openWith.length-string.closeWith.length;caretOffset=$$.val().substring(caretPosition,$$.val().length).length;caretOffset-=fixOperaBug($$.val().substring(0,caretPosition))}$.extend(hash,{caretPosition:caretPosition,scrollPosition:scrollPosition});if(string.block!==selection&&abort===false){insert(string.block);set(start,len)}else{caretOffset=-1}get();$.extend(hash,{line:"",selection:selection});if(ctrlKey===true&&shiftKey===true){prepare(clicked.afterMultiInsert)}prepare(clicked.afterInsert);prepare(options.afterInsert);if(previewWindow&&options.previewAutoRefresh){refreshPreview()}shiftKey=altKey=ctrlKey=abort=false}function fixOperaBug(string){if($.browser.opera){return string.length-string.replace(/\n*/g,"").length}return 0}function fixIeBug(string){if($.browser.msie){return string.length-string.replace(/\r*/g,"").length}return 0}function insert(block){if(document.selection){var newSelection=document.selection.createRange();newSelection.text=block}else{$$.val($$.val().substring(0,caretPosition)+block+$$.val().substring(caretPosition+selection.length,$$.val().length))}}function set(start,len){if(textarea.createTextRange){if($.browser.opera&&$.browser.version>=9.5&&len==0){return false}range=textarea.createTextRange();range.collapse(true);range.moveStart("character",start);range.moveEnd("character",len);range.select()}else{if(textarea.setSelectionRange){textarea.setSelectionRange(start,start+len)}}textarea.scrollTop=scrollPosition;textarea.focus()}function get(){textarea.focus();scrollPosition=textarea.scrollTop;if(document.selection){selection=document.selection.createRange().text;if($.browser.msie){var range=document.selection.createRange(),rangeCopy=range.duplicate();rangeCopy.moveToElementText(textarea);caretPosition=-1;while(rangeCopy.inRange(range)){rangeCopy.moveStart("character");caretPosition++}}else{caretPosition=textarea.selectionStart}}else{caretPosition=textarea.selectionStart;selection=$$.val().substring(caretPosition,textarea.selectionEnd)}return selection}function preview(){if(!previewWindow){iFrame=$('<div id="rtePreview" class="markItUpPreviewFrame"></div>');container=$$.attr("rel");if(container){iFrame.appendTo($(container));$(container).show()}else{iFrame.insertAfter(footer)}previewWindow=iFrame}else{if(altKey===true){if(iFrame){iFrame.remove()}previewWindow=iFrame=false}}if(!options.previewAutoRefresh){refreshPreview()}}function refreshPreview(){if(previewWindow){previewWindow.html(renderPreview())}}function renderPreview(){return converter.makeHtml($$.val())}function keyPressed(e){shiftKey=e.shiftKey;altKey=e.altKey;ctrlKey=(!(e.altKey&&e.ctrlKey))?e.ctrlKey:false;if(e.type==="keydown"){if(ctrlKey===true){li=$("a[accesskey="+String.fromCharCode(e.keyCode)+"]",header).parent("li");if(li.length!==0){ctrlKey=false;li.triggerHandler("mouseup");return false}}if(e.keyCode===13||e.keyCode===10){if(ctrlKey===true){ctrlKey=false;markup(options.onCtrlEnter);return options.onCtrlEnter.keepDefault}else{if(shiftKey===true){shiftKey=false;markup(options.onShiftEnter);return options.onShiftEnter.keepDefault}else{markup(options.onEnter);return options.onEnter.keepDefault}}}if(e.keyCode===9){if(shiftKey==true||ctrlKey==true||altKey==true){return false}if(caretOffset!==-1){get();caretOffset=$$.val().length-caretOffset;set(caretOffset,0);caretOffset=-1;return false}else{markup(options.onTab);return options.onTab.keepDefault}}refreshPreview()}}init()})};$.fn.markItUpRemove=function(){return this.each(function(){$$=$(this).unbind().removeClass("markItUpEditor");$$.parent("div").parent("div.markItUp").parent("div").replaceWith($$)})};$.markItUp=function(settings){var options={target:false};$.extend(options,settings);if(options.target){return $(options.target).each(function(){$(this).focus();$(this).trigger("insertion",[options])})}else{$("textarea").trigger("insertion",[options])}}})(jQuery);